<div
    class="h-[calc(100vh-64px)] overflow-y-auto bg-gray-50/50 dark:bg-gray-950 relative p-4 lg:p-10 transition-colors duration-300">
    <div class="max-w-7xl mx-auto min-h-full flex flex-col">

        <!-- Header -->
        <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
            <div>
                <h1
                    class="text-4xl lg:text-5xl font-extrabold text-gray-900 dark:text-gray-100 tracking-tight font-outfit mb-2">
                    Analytics</h1>
                <p class="text-lg text-gray-600 dark:text-gray-400 max-w-2xl leading-relaxed">{{ locationInfo.info }}
                </p>
            </div>
            <div class="flex items-center gap-3">
                <label
                    class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Estado:</label>
                <select (change)="setEstado($any($event.target).value)"
                    class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm cursor-pointer">
                    @for (key of dataService.stateKeys; track key) {
                    <option [value]="key" [selected]="key === selectedState">{{ dataService.states[key].sigla }} - {{
                        dataService.states[key].name }}</option>
                    }
                </select>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-1 mb-6 bg-gray-200 dark:bg-gray-800 p-1 rounded-xl w-fit flex-wrap">
            <button (click)="activeTab = 'ipa'"
                [class]="activeTab === 'ipa' ? 'px-5 py-2 bg-white dark:bg-gray-700 text-green-700 dark:text-green-400 font-bold rounded-lg shadow-sm text-sm' : 'px-5 py-2 text-gray-500 dark:text-gray-400 font-medium text-sm rounded-lg'">üèóÔ∏è
                IPA Ranking</button>
            <button (click)="activeTab = 'simulation'"
                [class]="activeTab === 'simulation' ? 'px-5 py-2 bg-white dark:bg-gray-700 text-green-700 dark:text-green-400 font-bold rounded-lg shadow-sm text-sm' : 'px-5 py-2 text-gray-500 dark:text-gray-400 font-medium text-sm rounded-lg'">‚ö°
                Simula√ß√£o</button>
            <button (click)="activeTab = 'sensitivity'"
                [class]="activeTab === 'sensitivity' ? 'px-5 py-2 bg-white dark:bg-gray-700 text-green-700 dark:text-green-400 font-bold rounded-lg shadow-sm text-sm' : 'px-5 py-2 text-gray-500 dark:text-gray-400 font-medium text-sm rounded-lg'">üî¨
                Sensibilidade</button>
            <button (click)="activeTab = 'indicators'"
                [class]="activeTab === 'indicators' ? 'px-5 py-2 bg-white dark:bg-gray-700 text-green-700 dark:text-green-400 font-bold rounded-lg shadow-sm text-sm' : 'px-5 py-2 text-gray-500 dark:text-gray-400 font-medium text-sm rounded-lg'">üå°Ô∏è
                Indicadores</button>
        </div>

        <!-- ===== IPA TAB ===== -->
        <div *ngIf="activeTab === 'ipa'">
            <div *ngIf="ipaLoading" class="flex flex-col items-center justify-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mb-4"></div>
                <p class="text-gray-500 dark:text-gray-400 font-medium animate-pulse">Calculando IPA-IVU...</p>
            </div>
            <div *ngIf="!ipaLoading">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div
                        class="bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-black text-red-600 dark:text-red-400">{{ ipaStats.muitoAlta }}</p>
                        <p class="text-xs font-bold text-red-700 dark:text-red-500 uppercase tracking-wider mt-1">üî¥
                            Muito Alta</p>
                    </div>
                    <div
                        class="bg-orange-50 dark:bg-orange-950 border border-orange-200 dark:border-orange-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-black text-orange-600 dark:text-orange-400">{{ ipaStats.alta }}</p>
                        <p class="text-xs font-bold text-orange-700 dark:text-orange-500 uppercase tracking-wider mt-1">
                            üü† Alta</p>
                    </div>
                    <div
                        class="bg-yellow-50 dark:bg-yellow-950 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-black text-yellow-600 dark:text-yellow-400">{{ ipaStats.media }}</p>
                        <p class="text-xs font-bold text-yellow-700 dark:text-yellow-500 uppercase tracking-wider mt-1">
                            üü° M√©dia</p>
                    </div>
                    <div
                        class="bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-black text-green-600 dark:text-green-400">{{ ipaStats.baixa }}</p>
                        <p class="text-xs font-bold text-green-700 dark:text-green-500 uppercase tracking-wider mt-1">üü¢
                            Baixa</p>
                    </div>
                </div>
                <div class="bg-gray-900 dark:bg-gray-800 rounded-xl p-5 mb-6 text-white shadow-lg">
                    <h3 class="text-lg font-bold">IPA = 0.4√óH + 0.3√óW + 0.3√óP</h3>
                    <p class="text-gray-400 text-xs mt-1">Normaliza√ß√£o percentil | {{ setoresIPA.length }} setores</p>
                    <div class="flex gap-6 mt-3 text-xs flex-wrap">
                        <span class="text-red-300">üå°Ô∏è H = 0.5√óLST + 0.3√óImperm + 0.2√óNDVI‚Åª¬π</span>
                        <span class="text-blue-300">üíß W = 0.4√óTWI + 0.3√óImperm + 0.3√óDecliv</span>
                        <span class="text-purple-300">üë• P = 0.4√óDens + 0.4√óRenda‚Åª¬π + 0.2√óIdosos</span>
                    </div>
                </div>
                <div
                    class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    <th
                                        class="px-4 py-3 text-left text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">
                                        #</th>
                                    <th
                                        class="px-4 py-3 text-left text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">
                                        RA</th>
                                    <th class="px-4 py-3 text-center text-[10px] font-bold text-red-500 uppercase">H
                                    </th>
                                    <th class="px-4 py-3 text-center text-[10px] font-bold text-blue-500 uppercase">W
                                    </th>
                                    <th class="px-4 py-3 text-center text-[10px] font-bold text-purple-500 uppercase">P
                                    </th>
                                    <th
                                        class="px-4 py-3 text-left text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">
                                        IPA</th>
                                    <th
                                        class="px-4 py-3 text-left text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">
                                        Cat.</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (setor of setoresIPA; track setor.id_ra; let i = $index) {
                                <tr
                                    class="border-t border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                    <td class="px-4 py-2.5 text-gray-400 font-mono text-xs">{{ i + 1 }}</td>
                                    <td class="px-4 py-2.5 font-semibold text-gray-800 dark:text-gray-200 text-xs">{{
                                        setor.ra_nome }}</td>
                                    <td class="px-4 py-2.5 text-center"><span
                                            class="bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 px-2 py-0.5 rounded font-bold text-xs">{{
                                            setor.modulo_h }}</span></td>
                                    <td class="px-4 py-2.5 text-center"><span
                                            class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded font-bold text-xs">{{
                                            setor.modulo_w }}</span></td>
                                    <td class="px-4 py-2.5 text-center"><span
                                            class="bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-2 py-0.5 rounded font-bold text-xs">{{
                                            setor.modulo_p }}</span></td>
                                    <td class="px-4 py-2.5">
                                        <div class="flex items-center gap-2">
                                            <span class="font-black text-gray-900 dark:text-gray-100 w-10 text-xs">{{
                                                setor.ipa_score }}</span>
                                            <div
                                                class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2 max-w-[100px]">
                                                <div class="h-2 rounded-full"
                                                    [style.width.%]="getScoreBarWidth(setor.ipa_score)"
                                                    [style.background-color]="setor.ipa_cor"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-2.5"><span
                                            class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase"
                                            [style.background-color]="setor.ipa_cor + '20'"
                                            [style.color]="setor.ipa_cor">{{ setor.ipa_categoria }}</span></td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== SIMULATION TAB ===== -->
        <div *ngIf="activeTab === 'simulation' && !ipaLoading">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Controls -->
                <div
                    class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-1">‚öôÔ∏è Par√¢metros de Interven√ß√£o
                    </h3>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Fonte: <a
                            href="https://www.wribrasil.org.br/noticias/impactos-calor-urbano-cidades-solucoes-passivas-natureza-adaptacao"
                            target="_blank" class="text-green-600 underline">WRI Brasil (2025)</a></p>
                    <!-- RA select -->
                    <div class="mb-4">
                        <label
                            class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1 block">Regi√£o
                            Administrativa</label>
                        <select [(ngModel)]="selectedSetorIndex" (ngModelChange)="runSimulation()"
                            class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg text-sm text-gray-700 dark:text-gray-200">
                            @for (setor of setoresIPA; track setor.id_ra; let i = $index) {
                            <option [ngValue]="i">#{{ i+1 }} {{ setor.ra_nome }} (IPA: {{ setor.ipa_score }})</option>
                            }
                        </select>
                    </div>
                    <!-- Cen√°rio -->
                    <div class="mb-4">
                        <label
                            class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1 block">Cen√°rio</label>
                        <div class="flex gap-2">
                            <button (click)="cenario = 'conservador'; runSimulation()"
                                [class]="cenario === 'conservador' ? 'flex-1 px-3 py-2 bg-green-600 text-white text-xs font-bold rounded-lg' : 'flex-1 px-3 py-2 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-xs font-medium rounded-lg border border-gray-200 dark:border-gray-700'">Conservador</button>
                            <button (click)="cenario = 'medio'; runSimulation()"
                                [class]="cenario === 'medio' ? 'flex-1 px-3 py-2 bg-green-600 text-white text-xs font-bold rounded-lg' : 'flex-1 px-3 py-2 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-xs font-medium rounded-lg border border-gray-200 dark:border-gray-700'">M√©dio</button>
                            <button (click)="cenario = 'agressivo'; runSimulation()"
                                [class]="cenario === 'agressivo' ? 'flex-1 px-3 py-2 bg-green-600 text-white text-xs font-bold rounded-lg' : 'flex-1 px-3 py-2 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-xs font-medium rounded-lg border border-gray-200 dark:border-gray-700'">Agressivo</button>
                        </div>
                    </div>
                    <!-- Section: Nature-based -->
                    <p
                        class="text-[10px] font-bold text-green-700 dark:text-green-500 uppercase tracking-widest mb-3 mt-2 border-b border-green-200 dark:border-green-800 pb-1">
                        üåø Solu√ß√µes baseadas na natureza</p>
                    <div class="space-y-4 mb-5">
                        <div>
                            <div class="flex justify-between mb-0.5">
                                <label class="text-xs font-bold text-green-700 dark:text-green-400">üå≥ Cobertura
                                    Arb√≥rea</label>
                                <span class="text-sm font-black text-green-600">{{ simInput.aumentoCoberturaArborea
                                    }}%</span>
                            </div>
                            <input type="range" min="0" max="50" step="1" [(ngModel)]="simInput.aumentoCoberturaArborea"
                                (ngModelChange)="runSimulation()" class="w-full accent-green-600">
                        </div>
                        <div>
                            <div class="flex justify-between mb-0.5">
                                <label class="text-xs font-bold text-emerald-700 dark:text-emerald-400">üåø √Årea
                                    Verde</label>
                                <span class="text-sm font-black text-emerald-600">{{ simInput.aumentoAreaVerde
                                    }}%</span>
                            </div>
                            <input type="range" min="0" max="30" step="1" [(ngModel)]="simInput.aumentoAreaVerde"
                                (ngModelChange)="runSimulation()" class="w-full accent-emerald-600">
                        </div>
                        <div>
                            <div class="flex justify-between mb-0.5">
                                <label class="text-xs font-bold text-blue-700 dark:text-blue-400">üèóÔ∏è Redu√ß√£o
                                    Impermeabiliza√ß√£o</label>
                                <span class="text-sm font-black text-blue-600">{{ simInput.reducaoImpermeabilizacao
                                    }}%</span>
                            </div>
                            <input type="range" min="0" max="40" step="1"
                                [(ngModel)]="simInput.reducaoImpermeabilizacao" (ngModelChange)="runSimulation()"
                                class="w-full accent-blue-600">
                        </div>
                    </div>
                    <!-- Section: Infrastructure -->
                    <p
                        class="text-[10px] font-bold text-purple-700 dark:text-purple-500 uppercase tracking-widest mb-3 border-b border-purple-200 dark:border-purple-800 pb-1">
                        üè† Solu√ß√µes de infraestrutura (WRI)</p>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-0.5">
                                <label class="text-xs font-bold text-green-800 dark:text-green-400">üåø Telhados
                                    Verdes</label>
                                <span class="text-sm font-black text-green-700">{{ simInput.telhadosVerdes }}%</span>
                            </div>
                            <input type="range" min="0" max="50" step="1" [(ngModel)]="simInput.telhadosVerdes"
                                (ngModelChange)="runSimulation()" class="w-full accent-green-700">
                        </div>
                        <div>
                            <div class="flex justify-between mb-0.5">
                                <label class="text-xs font-bold text-violet-700 dark:text-violet-400">üè† Telhados Frios
                                    (reflexivos)</label>
                                <span class="text-sm font-black text-violet-600">{{ simInput.telhadosFrios }}%</span>
                            </div>
                            <input type="range" min="0" max="80" step="1" [(ngModel)]="simInput.telhadosFrios"
                                (ngModelChange)="runSimulation()" class="w-full accent-violet-600">
                            <p class="text-[9px] text-gray-400 mt-0.5">Phoenix: -7¬∞C LST | Mal√°sia: -13% energia</p>
                        </div>
                        <div>
                            <div class="flex justify-between mb-0.5">
                                <label class="text-xs font-bold text-purple-700 dark:text-purple-400">üõ£Ô∏è Pavimentos
                                    Frios</label>
                                <span class="text-sm font-black text-purple-600">{{ simInput.pavimentosFrios }}%</span>
                            </div>
                            <input type="range" min="0" max="60" step="1" [(ngModel)]="simInput.pavimentosFrios"
                                (ngModelChange)="runSimulation()" class="w-full accent-purple-600">
                            <p class="text-[9px] text-gray-400 mt-0.5">Albedo asfalto 0.05 ‚Üí reflexivo 0.35</p>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div class="space-y-4" *ngIf="simResult && getSelectedSetor() as setor">
                    <!-- Thermal -->
                    <div
                        class="bg-gradient-to-br from-orange-50 to-red-50 dark:from-red-950 dark:to-orange-950 rounded-xl border border-red-200 dark:border-red-800 p-5">
                        <h4 class="text-sm font-bold text-red-800 dark:text-red-400 uppercase tracking-wider mb-4">üå°Ô∏è
                            Simula√ß√£o T√©rmica</h4>
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="text-center">
                                <p class="text-3xl font-black text-red-600 dark:text-red-400">{{ simResult.deltaLST }}¬∞
                                </p>
                                <p class="text-[10px] text-red-500 font-bold uppercase mt-1">ŒîLST</p>
                            </div>
                            <div class="text-center">
                                <p class="text-3xl font-black text-orange-600 dark:text-orange-400">{{
                                    simResult.lstSimulado }}¬∞</p>
                                <p class="text-[10px] text-orange-500 font-bold uppercase mt-1">LST Simulado</p>
                                <p class="text-[9px] text-gray-400 mt-0.5">Atual: {{ setor.lst_p90 }}¬∞C</p>
                            </div>
                            <div class="text-center">
                                <p class="text-3xl font-black text-green-600 dark:text-green-400">+{{
                                    simResult.deltaConfortoTermico }}%</p>
                                <p class="text-[10px] text-green-600 font-bold uppercase mt-1">Conforto</p>
                            </div>
                        </div>
                        <!-- Contribution breakdown -->
                        <div *ngIf="simResult.contribuicoes.length > 0"
                            class="border-t border-red-200 dark:border-red-800 pt-3 mt-2">
                            <p class="text-[10px] font-bold text-red-700 dark:text-red-400 uppercase mb-2">Contribui√ß√£o
                                por solu√ß√£o</p>
                            @for (c of simResult.contribuicoes; track c.nome) {
                            <div class="flex items-center gap-2 mb-1.5">
                                <span class="text-[10px] text-gray-600 dark:text-gray-300 w-32 truncate">{{ c.nome
                                    }}</span>
                                <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                                    <div class="h-2 rounded-full" [style.width.%]="(c.delta / simResult.deltaLST) * 100"
                                        [style.background-color]="c.cor"></div>
                                </div>
                                <span class="text-[10px] font-bold w-12 text-right" [style.color]="c.cor">{{ c.delta
                                    }}¬∞</span>
                            </div>
                            }
                        </div>
                    </div>
                    <!-- Hydrological + Energy -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div
                            class="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-950 dark:to-cyan-950 rounded-xl border border-blue-200 dark:border-blue-800 p-5">
                            <h4
                                class="text-sm font-bold text-blue-800 dark:text-blue-400 uppercase tracking-wider mb-3">
                                üíß H√≠drica</h4>
                            <div class="text-center mb-2">
                                <p class="text-3xl font-black text-blue-600 dark:text-blue-400">-{{
                                    simResult.reducaoEscoamento }}%</p>
                                <p class="text-[10px] text-blue-500 font-bold uppercase">Escoamento</p>
                            </div>
                            <div class="text-center mb-2">
                                <p class="text-2xl font-black text-cyan-600 dark:text-cyan-400">+{{
                                    simResult.aumentoInfiltracao }}%</p>
                                <p class="text-[10px] text-cyan-600 font-bold uppercase">Infiltra√ß√£o</p>
                            </div>
                            <div class="flex justify-center gap-4 text-[10px] text-gray-500 dark:text-gray-400">
                                <span>CN: <b class="text-gray-800 dark:text-gray-200">{{ simResult.cnOriginal
                                        }}</b></span>
                                <span>‚Üí</span>
                                <span>CN: <b class="text-green-600">{{ simResult.cnSimulado }}</b></span>
                            </div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-amber-50 to-yellow-50 dark:from-amber-950 dark:to-yellow-950 rounded-xl border border-amber-200 dark:border-amber-800 p-5">
                            <h4
                                class="text-sm font-bold text-amber-800 dark:text-amber-400 uppercase tracking-wider mb-3">
                                ‚ö° Energia</h4>
                            <div class="text-center mb-2">
                                <p class="text-3xl font-black text-amber-600 dark:text-amber-400">-{{
                                    simResult.reducaoEnergia }}%</p>
                                <p class="text-[10px] text-amber-600 font-bold uppercase">Consumo AC</p>
                            </div>
                            <p class="text-[9px] text-gray-400 text-center">Telhados frios reduzem demanda de
                                ar-condicionado (WRI/Mal√°sia)</p>
                        </div>
                    </div>
                    <!-- Context -->
                    <div
                        class="bg-gray-100 dark:bg-gray-800 rounded-xl p-4 text-xs text-gray-600 dark:text-gray-400 leading-relaxed">
                        <b class="text-gray-800 dark:text-gray-200">Cen√°rio {{ cenario }}:</b> Coeficientes baseados em
                        <a href="https://www.wribrasil.org.br/noticias/impactos-calor-urbano-cidades-solucoes-passivas-natureza-adaptacao"
                            target="_blank" class="text-green-600 underline">WRI Brasil (2025)</a>,
                        EPA Urban Heat Island Compendium, Oke (2017), Ziter (2019). SCS-CN conforme USDA TR-55.
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== SENSITIVITY TAB ===== -->
        <div *ngIf="activeTab === 'sensitivity' && sensitivityResults.length > 0">
            <div
                class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-2">üî¨ An√°lise de Sensibilidade dos
                    Pesos</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Varia√ß√£o de ¬±20% em cada m√≥dulo para avaliar
                    robustez do ranking</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th
                                    class="px-4 py-3 text-left text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">
                                    Cen√°rio</th>
                                <th class="px-4 py-3 text-center text-[10px] font-bold text-red-500 uppercase">H</th>
                                <th class="px-4 py-3 text-center text-[10px] font-bold text-blue-500 uppercase">W</th>
                                <th class="px-4 py-3 text-center text-[10px] font-bold text-purple-500 uppercase">P</th>
                                <th
                                    class="px-4 py-3 text-center text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">
                                    M√©dia</th>
                                <th
                                    class="px-4 py-3 text-left text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">
                                    Top 5 Setores</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (row of sensitivityResults; track row.label; let i = $index) {
                            <tr class="border-t border-gray-100 dark:border-gray-800" [class.bg-green-50]="i === 0">
                                <td class="px-4 py-3 font-semibold text-gray-800 dark:text-gray-200 text-xs">
                                    {{ row.label }}
                                    <span *ngIf="i === 0"
                                        class="ml-2 text-[9px] bg-green-600 text-white px-1.5 py-0.5 rounded uppercase font-bold">Base</span>
                                </td>
                                <td class="px-4 py-3 text-center font-bold text-red-600 dark:text-red-400 text-xs">{{
                                    row.pesoH }}</td>
                                <td class="px-4 py-3 text-center font-bold text-blue-600 dark:text-blue-400 text-xs">{{
                                    row.pesoW }}</td>
                                <td
                                    class="px-4 py-3 text-center font-bold text-purple-600 dark:text-purple-400 text-xs">
                                    {{ row.pesoP }}</td>
                                <td class="px-4 py-3 text-center font-black text-gray-900 dark:text-gray-100 text-xs">{{
                                    row.avgScore }}</td>
                                <td class="px-4 py-3">
                                    <div class="flex flex-wrap gap-1">
                                        @for (s of row.topSetores; track s.id) {
                                        <span
                                            class="inline-block px-2 py-0.5 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded text-[10px] font-medium border border-gray-200 dark:border-gray-700">{{
                                            s.ra }} ({{ s.score }})</span>
                                        }
                                    </div>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-xl p-5">
                <h4 class="text-sm font-bold text-amber-800 dark:text-amber-400 mb-2">üìù Interpreta√ß√£o</h4>
                <p class="text-sm text-amber-700 dark:text-amber-400 leading-relaxed">Se o ranking dos Top 5 <b>n√£o
                        muda</b> significativamente entre os cen√°rios, isso indica <b>robustez</b> do modelo ‚Äî os
                    setores priorit√°rios s√£o consistentes independente dos pesos. Varia√ß√µes no Top 5 indicam que o setor
                    est√° na <b>zona de transi√ß√£o</b> entre categorias.</p>
            </div>
        </div>

        <!-- ===== INDICATORS TAB ===== -->
        <div *ngIf="activeTab === 'indicators'">
            <div class="flex items-center gap-3 mb-8 overflow-x-auto pb-2">
                <span class="text-sm font-semibold text-gray-400 uppercase tracking-widest mr-2">Cidade:</span>
                <div class="flex gap-2">
                    @for (city of currentCities; track city.name) {
                    <button (click)="selectCity(city)" [class.bg-green-700]="selectedCityName === city.name"
                        [class.text-white]="selectedCityName === city.name"
                        [class.bg-white]="selectedCityName !== city.name"
                        [class.dark:bg-gray-800]="selectedCityName !== city.name"
                        [class.text-gray-600]="selectedCityName !== city.name"
                        [class.dark:text-gray-300]="selectedCityName !== city.name"
                        [class.border-gray-200]="selectedCityName !== city.name"
                        [class.dark:border-gray-700]="selectedCityName !== city.name"
                        class="px-4 py-2 rounded-xl border text-sm font-semibold transition-all whitespace-nowrap">{{
                        city.name }}</button>
                    }
                </div>
            </div>
            <div *ngIf="isLoading" class="flex flex-col items-center justify-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mb-4"></div>
            </div>
            <div *ngIf="!isLoading" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div
                    class="bg-gradient-to-br from-orange-50 to-red-50 dark:from-red-950 dark:to-orange-950 rounded-xl shadow-sm border border-red-100 dark:border-red-800 p-6">
                    <h3 class="text-sm font-bold text-red-800 dark:text-red-400 uppercase tracking-widest mb-2">
                        Temperatura</h3>
                    <p class="text-4xl font-black text-red-600 dark:text-red-400">{{ indicators.temperature }}</p>
                </div>
                <div
                    class="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-950 dark:to-cyan-950 rounded-xl shadow-sm border border-blue-100 dark:border-blue-800 p-6">
                    <h3 class="text-sm font-bold text-blue-800 dark:text-blue-400 uppercase tracking-widest mb-2">
                        Alagamento</h3>
                    <p class="text-3xl font-black text-blue-600 dark:text-blue-400">{{ indicators.floodRisk }}</p>
                </div>
                <div
                    class="bg-gradient-to-br from-stone-50 to-stone-100 dark:from-gray-800 dark:to-gray-900 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700 p-6">
                    <h3 class="text-sm font-bold text-stone-800 dark:text-stone-300 uppercase tracking-widest mb-2">
                        Altitude</h3>
                    <p class="text-4xl font-black text-stone-600 dark:text-stone-300">{{ indicators.elevation }}</p>
                </div>
            </div>
            <div *ngIf="!isLoading && timeline.length > 0"
                class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-6 mb-8">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4">üìä Timeline (7 dias)</h3>
                <div class="flex items-end gap-3" style="height: 200px;">
                    @for (point of timeline; track point.date) {
                    <div class="flex-1 flex flex-col items-center h-full justify-end">
                        <span class="text-[11px] font-bold text-red-600 dark:text-red-400 mb-1">{{ point.tempMax
                            }}¬∞</span>
                        <div class="w-4/5 max-w-[40px] bg-gradient-to-t from-red-500 to-orange-300 rounded-t-md"
                            [style.height.px]="getBarHeightPx(point.tempMax)"></div>
                        <div class="h-1"></div>
                        <div class="w-4/5 max-w-[40px] bg-gradient-to-t from-blue-500 to-cyan-300 rounded-t-md"
                            [style.height.px]="getBarHeightPx(point.tempMin)"></div>
                        <span class="text-[11px] font-bold text-blue-600 dark:text-blue-400 mt-1">{{ point.tempMin
                            }}¬∞</span>
                        <span class="text-[10px] text-gray-500 dark:text-gray-400 mt-1">{{ formatDate(point.date)
                            }}</span>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>